version: '3.9'

networks:
   elias_network:
      name: elias_network
      driver: bridge

volumes:
    elias_volume_system:
        external: true
    # elias_volume_mq_data:
    #     external: true
    # elias_volume_mq_log:
    #     external: true

services:
  elias_qs_mysql_db:
    image: mysql:latest
    container_name: elias_qs_mysql_db
    hostname: elias_qs_mysql_db
    restart: always
    environment:
      - MYSQL_TCP_PORT=3306
      - MYSQL_ROOT_PASSWORD=1234qQ1!
    ports:
      - 43306:3306
    volumes:
      - elias_volume_system:/var/lib/mysql
    networks:
      - elias_network

  elias_cache_redis:
    image: redis:latest
    container_name: elias_cache_redis
    hostname: elias_cache_redis
    restart: always
    ports:
      - 6379:6379
    networks:
      - elias_network
  
  elias_message_queue_rabbit_mq:
    image: rabbitmq:management
    container_name: elias_message_queue_rabbit_mq
    hostname: elias_message_queue_rabbit_mq
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    # volumes:
    #   - elias_volume_mq_data:/var/lib/rabbitmq
    #   - elias_volume_mq_log:/val/log/rabbitmq
    ports:
      - 5672:5672
    networks:
      - elias_network

  elias_gateway:
    image: ${DOCKER_REGISTRY-}elias_gateway
    container_name: elias_gateway
    hostname: elias_gateway
    restart: always
    build:
      context: .
      dockerfile: _system/ELIAS_Gateway/Dockerfile
    ports:
      - 51201:51201
      - 51202:51202
    networks:
      - elias_network
    depends_on:
      - elias_qs_mysql_db
      - elias_cache_redis
      - elias_message_queue_rabbit_mq

  elias_query_service:
    image: ${DOCKER_REGISTRY-}elias_query_service
    container_name: elias_query_service
    hostname: elias_query_service
    restart: always
    build:
      context: .
      dockerfile: Query_Service/Query_Service/Dockerfile
    ports:
      - 51210:51210
      - 51211:51211
    networks:
      - elias_network
    depends_on:
      - elias_gateway

  elias_societal_service:
    image: ${DOCKER_REGISTRY-}elias_societal_service
    container_name: elias_societal_service
    hostname: elias_societal_service
    restart: always
    build:
      context: .
      dockerfile: Societal_Service/Societal_Service/Dockerfile
    ports:
      - 51220:51220
      - 51221:51221
    networks:
      - elias_network
    depends_on:
      - elias_query_service
